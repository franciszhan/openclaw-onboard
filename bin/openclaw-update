#!/usr/bin/env bash
set -euo pipefail

if [[ $EUID -ne 0 ]]; then
  echo "Run as root (sudo)" >&2
  exit 1
fi

APP_DIR=/opt/openclaw/app

if [[ ! -d "$APP_DIR/.git" ]]; then
  echo "Missing git repo at $APP_DIR" >&2
  exit 1
fi

echo "Updating OpenClaw in $APP_DIR"
cd "$APP_DIR"

git fetch --all --prune
# keep it simple: fast-forward to origin/main
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" != "main" ]]; then
  echo "Warning: current branch is $BRANCH (expected main)" >&2
fi

git pull --ff-only

if command -v npm >/dev/null 2>&1; then
  npm ci
  npm run build || true
else
  echo "npm not found" >&2
  exit 1
fi

systemctl restart openclaw
systemctl status openclaw --no-pager | sed -n '1,120p'
